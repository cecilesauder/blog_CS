---
title: 'La Gazette, mon petit canard : Concours'
author: CÃ©cile Sauder
date: '2022-11-25'
topics:
  - DataViz
  - Twitter
  - Text Analysis
tags:
  - wordcloud2
  - rtweet
  - magick
  - tidytext
  - tidyverse
header: "/img/31.png"
---



## Concours de la Gazette de Montpellier

Le jeu-concours : racontez-nous, sur le theÌ€me â€œLa Gazette, mon petit canardâ€, une histoire ou anecdote que vous inspire La Gazette : texte (court), poeÌ€me, chanson, videÌo, rap, histoire droÌ‚le, tableau, sculpture...

Laissez parler votre creÌativiteÌ. Les creÌations les plus originales, amusantes, pertinentes, eÌmouvantes, acides, deÌlirantes,... gagneront lâ€™un des 35 lots. Surprenez-nous !

-  Envoyez votre production (texte, videÌo, photo, etc.) par mail Ã  jb.decroix@gazettedemontpellier.fr

- Obligatoire : merci dâ€™indiquer preÌnom, nom, aÌ‚ge, adresse postale, adresse mail et numeÌro de teÌleÌphone + une copie de votre pieÌ€ce dâ€™identiteÌ, afin que votre inscription soit valideÌe par retour de mail.

- Date limite des envois : le jeudi 24 novembre 2022.

- SoireÌe de remise des prix : le mercredi 7 dÃ©cembre 2022.

[Tweet de la Gazette Live Montpellier :](https://twitter.com/GazetteLive34/status/1572831094889713664).



```{r echo=FALSE}

blogdown::shortcode_html("tweet", "1572831094889713664" )

```



## L'idÃ©e 

Une ShinyApp avec seulement un slider et une image qui correspond Ã  un 
WordCloud en forme de Canard, fait avec les mots recueillis sur le compte
twitter.

J'ai longtemps hÃ©sitÃ©, une version calendrier avec les 12 mois d'une annÃ©e 
je trouvais Ã§a sympa aussi. 


## RÃ©cupÃ©rer les tweets et les nettoyer

### Librairies

```{r, message=FALSE, warning=FALSE}

library(tidyverse)
library(rtweet)
library(tidytext)
library(proustr)
library(stopwords)
library(lubridate)
library(wordcloud2)
library(glue)
library(magick)

```


### Obtenir les 3250 derniers tweets de la @GazelleLive34

Je l'ai sauvÃ© quand je l'ai fait car ensuite on n'a plus les mÃªmes tweets 
on en a des plus rÃ©cents forcÃ©ment. 

```{r, eval=FALSE}

#tmls <- get_timeline("GazetteLive34",
                     retryonratelimit = TRUE,
                     n = 3250)

#saveRDS(tmls, file = "timelines_3250_24_11_22.RDS")
```

### Gros nettoyage !

Alors j'ai nettoyÃ© au mieux mais ce que j'aime pas Ã§a !

En plus c'est jamais uniforme bien sÃ»r, genre "l'avion" ou "l`avion" c'est
pas pareil, non non non... Y a aussi des emojis mais bon on va faire avec.

Donc on tokenize au format "tweet", puis on enlÃ¨ve les stopwords avec

` proustr::proust_stopwords()` ainsi que 
` stopwords::stopwords("fr, source = "stopwords-iso)`


```{r}
tmls <- readRDS("timelines_3250_24_11_22.RDS")


mots <- tmls %>%
  select(created_at, id, text) %>%
  mutate(text=str_replace_all(text, "'", " ")) %>%
  mutate(text=str_replace_all(text, "â€™", " ")) %>%
  mutate(text=str_squish(text)) %>%
  filter(str_detect(text, "La Gazette est en ligne", negate = TRUE)) %>%
  filter(str_detect(text, "application mobile", negate = TRUE)) %>%
  unnest_tokens(word, input = text, token = "tweets") %>%
  filter(str_detect(word, "[:space:]", negate = TRUE)) %>%
  filter(str_detect(word, "https", negate = TRUE)) %>%
  filter(str_detect(word, "t.co", negate = TRUE)) %>%
  filter(!word %in% proust_stopwords()) %>%
  filter(!word %in% stopwords("fr", source = "stopwords-iso")) %>%
  filter(str_detect(word, "\\D")) %>%
  filter(!word =="ans") %>%
  filter(!word =="an") %>%
  filter(!word =="Â°") %>%
  filter(!word =="Â°") %>%
  filter(!word =="â‚¬") %>%
  filter(!is.na(word)) %>%
  filter(!word == " ") %>%
  filter(!word == "tco") %>%
  filter(!word == "ğŸ‘‡") %>%
  filter(!word == "ğŸ‘‡ğŸ»") %>%
  filter(!word %in% c("montpellier", "#montpellier", "gazette", "hÃ©rault",
                      "lundi", "mardi", "mercredi", "jeudi",
                      "vendredi", "samedi", "dimanche", "deux", "trois",
                      "st", "saint", "euros", "rt", "gt",
                      "janvier", "fÃ©vrier", "mars", "avril", "mai",
                      "juin", "juillet", "aout", "aoÃ»t", "septembre",
                      "octobre", "novembre", "dÃ©cembre")) %>%
  mutate(month = month(created_at),
         year = year(created_at))



slider_values <- c("05_2020",
                   "06_2020",
                   "07_2020",
                   "08_2020",
                   "09_2020",
                   "10_2020",
                   "11_2020",
                   "12_2020",
                   "01_2021",
                   "02_2021",
                   "03_2021",
                   "04_2021",
                   "05_2021",
                   "06_2021",
                   "07_2021",
                   "08_2021",
                   "09_2021",
                   "10_2021",
                   "11_2021",
                   "12_2021",
                   "01_2022",
                   "02_2022",
                   "03_2022",
                   "04_2022",
                   "05_2022",
                   "06_2022",
                   "07_2022",
                   "08_2022",
                   "09_2022",
                   "10_2022",
                   "11_2022")

tib <- mots %>%
  filter(year == "2022" & month == "11") %>%
  count(word, sort = TRUE) %>%
  mutate(freq= 100*n/ sum(n)) %>%
  select(-n)


```
J'ai ajoutÃ© Ã  la main les `slider_values`

Dans ` tib` je filtre pour choisir le mois et l'annÃ©e que je veux, et Ã  chaque fois
il faudra que j'affiche le WordCloud correspondant pour essayer de le sauvergarder
en ` .png`


## WordCloud ou WordDuck 

Alors oui, je pourrais faire une fonction qui prend en arguments le mois et l'annÃ©e,
mais comme de toutes faÃ§ons la fonction ` wordcloud2() ` avec `figPath`, faut l'actualiser un paquet de fois dans un navigateur pour la faire fonctionner... Ben oui c'est un bug connu il semblerait.

La forme Ã§a ressemble Ã  Ã§a d'ailleurs : 

```{r}

image_read("duck_shape.png") %>%
  image_scale("800x")
```


J'ai donc plus qu'Ã  faire le wordcloud correspondant, l'afficher dans un navigateur
qui veut bien, et l'enregistrer en `.png` via un clic droit `r emoji::emoji("sweat_smile")`
et Ã§a 31 fois, pfiou !

```{r}

wc2 <- wordcloud2(data = tib,
                  fontFamily = "Chilanka",
                  fontWeight = 'bold',
                  backgroundColor = "#048b9a",
                  figPath = "duck_shape.png",
                  widgetsize = c(1200,1200),
                  color = rep(
                    c(
                      rep("yellow", 6),
                      rep("#F4E100", 4),
                      rep("orange", 2),
                      rep("red", 2),
                      "black"
                    )
                    , nrow(tib)))

wc2

```



Bon je me rends compte au passage que Ã§a prend vraiment trop de temps 
pour afficher le HTML donc je dÃ©cide d'afficher en images non interactives dans 
la shiny app.

Tu peux tester, y a de grandes chances que tu ne vois qu'un fond bleu 
canard si dessus, si t'actualises la page assez de fois, je crois qu'avec Firefox 
y a un temps plus long Ã§a marchait un peu mieux quand j'ai fait les 31, tu verras
le canard formÃ© avec les mots des titres du mois de novembre 2022...

Et tu remarqueras au passage que la grosse marche contre les VSS du 19/11 passe
bien inaperÃ§ue face aux motards et Ã  la coupe du monde `r emoji::emoji("disgusted")`

Enfin, on en Ã©tait oÃ¹ ?


J'enregistre donc mes 31 images ` X.png ` avec X de 1 Ã  31, c'est important 
car on ne peut pas mettre les valeurs que l'on veut dans le slider.

Ce sera facile de faire le lien entre slider et nom d'image. 


### Customisation des images de WordCloud

<iframe src="https://giphy.com/embed/F3H25CjboPkTm" width="480" height="479" frameBorder="0" class="giphy-embed" allowFullScreen></iframe>

C'est magic... Enfin je vais juste faire une boucle for qui va itÃ©rer de 1 Ã  31 quoi...


Alors Ã§a je le fais pas tourner hin, Ã§a lit l'image du numÃ©ro de l'itÃ©ration de la boucle.

Puis le nom est changÃ© car plus lisible avec "/" qu'avec "-", police, couleur, 
petite bordure qui va bien, puis je sauve l'image du mÃªme nom qu'avant, elle sera appelÃ© 
direct avec le slider.




```{r, eval=FALSE}
for (i in 1:31) {

  img <- image_read(glue('www/img/{i}.png'))

  img %>%
    image_border( "#e7f00d", "0x100") %>%
    image_annotate(str_replace(slider_values[i], "_", "/"),
                   font = "Chilanka",
                   strokecolor = "#048b9a",
                   color = "black",
                   weight = 800,
                   size = 80,
                   location = "+450+15") %>%
    image_crop("1200x1300") %>%
    image_border( "black", "10x10") %>%
    image_write(path = glue('www/img/{i}.png'))

}
```


Je voulais les combiner aussi pour en faire un calendrier. 

Ã‡a doit se faire qqs lignes avec `magick` mais lÃ , la flemme `r emoji::emoji("sweat_smile")`

Donc on est dÃ©jÃ  le 26 et je me disais que la partie `Shiny` mÃ©rite bien un post
Ã  elle seule et que donc je vais en finir pour aujourdhui. Je rajouterais 
sÃ»rement des miniatures des images crÃ©Ã©es par la boucle demain et un post sur la 
partie Shiny et comment changer le bouton du slider en CSS...

Allez je retourne matter le Quotidien en replay ! Mais comme je suis trop 
sympa je te laisse avec des citations de Kaamelott donc si tu veux rester plantÃ©.e
lÃ  comme un radis y a aucun soucis... 

<iframe src="https://kgif.fr/g/bdb05b897b" width="100%" height="479" frameBorder="0" class="giphy-embed" allowFullScreen></iframe>
